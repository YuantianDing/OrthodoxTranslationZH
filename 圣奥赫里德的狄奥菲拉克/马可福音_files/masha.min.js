!function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var n=t();for(var s in n)n.hasOwnProperty(s)&&(e[s]=n[s])}}(this,(function(){"use strict";var e={},t=function(){};t.prototype={setHash:function(e){window.location.hash=e},getHash:function(){return window.location.hash},addHashchange:function(e){this.callback=e,C(window,"hashchange",e)},destroy:function(){this.callback&&k(window,"hashchange",this.callback)},_removeHash:function(){window.history.pushState?history.pushState("",document.title,window.location.pathname+window.location.search):this.setHash("")}};var n=function(e){"select_message"in(e=e||{})&&(e.selectMessage=e.select_message),"enable_haschange"in e&&(e.enableHaschange=e.enable_haschange),"is_block"in e&&(e.isBlock=e.is_block),this.options=o({},n.defaultOptions,e),o(this,{counter:0,ranges:{},blocks:{}}),this.init()};n.version="25.04.2013-09:55:11",n.LocationHandler=t,n.defaultOptions={regexp:"[^\\s,;:–.!?<>…\\n \\*]+",selectable:"selectable-content",marker:"txtselect_marker",ignored:null,selectMessage:null,location:new t,validate:!1,enableHaschange:!0,onMark:null,onUnmark:null,onHashRead:function(){var e=c(this.selectable,"user_selection_true");e&&!this.hashWasRead&&(this.hashWasRead=!0,window.setTimeout((function(){for(var t=0,n=0;e;)t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;window.scrollTo(t,n-150)}),1))},isBlock:function(e){return"BR"==e.nodeName||-1==w(function(e,t){var n="";document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,"").getPropertyValue(t):e.currentStyle&&(t=t.replace(/\-(\w)/g,(function(e,t){return t.toUpperCase()})),n=e.currentStyle[t]);return n}(e,"display"),["inline","none"])}},n.prototype={init:function(){if(this.selectable="string"==typeof this.options.selectable?document.getElementById(this.options.selectable):this.options.selectable,"string"==typeof this.options.marker?(this.marker=document.getElementById(this.options.marker),null===this.marker&&(this.marker=document.createElement("a"),this.marker.setAttribute("id",this.options.marker),this.marker.setAttribute("href","#"),document.body.appendChild(this.marker))):this.marker=this.options.marker,"string"!=typeof this.options.regexp)throw"regexp is set as string";(this.regexp=new RegExp(this.options.regexp,"ig"),this.selectable)&&(this.isIgnored=this.constructIgnored(this.options.ignored),this.options.selectMessage&&this.initMessage(),this.enumerateElements(),"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch?(this.touchEnd=x(this.touchEnd,this),C(this.selectable,"touchend",this.touchEnd)):(this.mouseUp=x(this.mouseUp,this),C(this.selectable,"mouseup",this.mouseUp)),this.markerClick=x(this.markerClick,this),C(this.marker,"click",this.markerClick),C(this.marker,"touchend",this.markerClick),this.hideMarker=x(this.hideMarker,this),C(document,"click",this.hideMarker),this.options.enableHaschange&&(this.hashChange=x(this.hashChange,this),this.options.location.addHashchange(this.hashChange)),this.readHash())},clearAllSelections:function(){this.options.location.destroy();var e=d(this.selectable,"user_selection_true");this.removeTextSelection(e);for(var t=d(this.selectable,"closewrap"),n=t.length;n--;)t[n].parentNode.removeChild(t[n])},destroy:function(){v(this.marker,"show"),this.options.selectMessage&&this.hideMessage(),k(this.selectable,"mouseup",this.mouseUp),k(this.selectable,"touchEnd",this.touchEnd),k(this.marker,"click",this.markerClick),k(this.marker,"touchend",this.markerClick),k(document,"click",this.hideMarker),this.clearAllSelections();for(var e=d(this.selectable,"masha_index"),t=e.length;t--;)e[t].parentNode.removeChild(e[t])},showMarkerFunc:function(){window.setTimeout(x((function(){var e=window.getSelection();if(e.rangeCount){var t=e.getRangeAt(0).getClientRects();if(t.length){var n=t[t.length-1],s=document.body;this.showMarker({x:n.left+n.width+(s.scrollLeft||window.scrollX),y:n.bottom+(s.scrollTop||window.scrollY)})}}}),this),1)},mouseUp:function(){this.showMarkerFunc()},touchEnd:function(){this.showMarkerFunc()},hashChange:function(){if(this.lastHash!=this.options.location.getHash()){var e=[];for(var t in this.ranges)e.push(t);this.deleteSelections(e),this.readHash()}},hideMarker:function(e){(e.target||e.srcElement)!=this.marker&&v(this.marker,"show"),this.lastRange=null},markerClick:function(e){b(e),function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}(e);var t=e.target||e.srcElement;if((!p(this.marker,"masha-marker-bar")||p(t,"masha-social")||p(t,"masha-marker"))&&(v(this.marker,"show"),this.rangeIsSelectable()&&(this.addSelection(),this.updateHash(),this.options.onMark&&this.options.onMark.call(this),this.options.selectMessage&&this._showMessage(),p(t,"masha-social")))){var n=t.getAttribute("data-pattern");if(n){var s=n.replace("{url}",encodeURIComponent(window.location.toString()));this.openShareWindow(s)}}},openShareWindow:function(e){window.open(e,"","status=no,toolbar=no,menubar=no,width=800,height=400")},getMarkerCoords:function(e,t){return{x:t.x,y:t.y,width:t.width}},getPositionChecksum:function(e){for(var t="",n=0;n<3;n++){var s=(e()||"").charAt(0);if(s){var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890",r=s.charCodeAt(0)%62;s=i.charAt(r)}t+=s}return t},showMarker:function(e){var t=new RegExp(this.options.regexp,"g"),s=window.getSelection().toString();if(""!=s&&t.test(s)&&this.rangeIsSelectable()){var i=this.getMarkerCoords(this.marker,e);this.marker.style.top=i.y+"px";var r=window.getSelection();r.rangeCount&&(this.lastRange=new n.Range(r.getRangeAt(0),this)),m(this.marker,"show")}},deleteSelections:function(e){for(var t=e.length;t--;){var n=e[t],s=d(this.selectable,n),i=c(s[s.length-1],"closewrap");i.parentNode.removeChild(i),this.removeTextSelection(s),delete this.ranges[n]}},removeTextSelection:function(e){for(var t=e.length;t--;){for(var n=e[t],s=0;s<n.childNodes.length;s++)n.parentNode.insertBefore(n.childNodes[s],n);n.parentNode.removeChild(n)}},isInternal:function(e){for(;e.parentNode;){if(e==this.selectable)return!0;e=e.parentNode}return!1},_siblingNode:function(e,t,n){n=n||this.regexp;var i=e;t&&i.previousSibling&&(i=i.previousSibling);var r=s(this.selectable,i,void 0,t,this.isIgnored);for((i=r())==e&&(i=r());i&&!(i instanceof HTMLDocument);){if(3==i.nodeType&&null!=i.data.match(n))return{_container:i,_offset:t*i.data.length};i=r()}return null},prevNode:function(e,t){return this._siblingNode(e,1,t)},nextNode:function(e,t){return this._siblingNode(e,0,t)},wordCount:function(e){var t=0;if(3==e.nodeType){var n=e.nodeValue.match(this.regexp);n&&(t+=n.length)}else if(e.childNodes&&e.childNodes.length)for(var s=f(e),i=s.length;i--;)t+=s[i].nodeValue.match(this.regexp).length;return t},words:function(e,t,n){var i=s(this.selectable,e,void 0,"end"===n,this.isIgnored)();i!==e&&(t="end"==n&&3==i.nodeType?i.textContent.length:0,e=i),1==e.nodeType&&(e=u(e,this.isIgnored));var r=e.data.substring(0,t).match(this.regexp);null!=r?("start"==n&&(r=r.length+1),"end"==n&&(r=r.length)):r=1;for(var o=e,a=this.getNum(e),h=this.getFirstTextNode(a);o&&o!=h;)null!==(o=this.prevNode(o,/.*/))&&(o=o._container,r+=this.wordCount(o));return a+":"+r},symbols:function(e){var t=0;if(3==e.nodeType)t=e.nodeValue.length;else if(e.childNodes&&e.childNodes.length)for(var n=f(e),s=n.length;s--;)t+=n[s].nodeValue.length;return t},updateHash:function(){var e=[];for(var t in this.ranges)e.push(this.ranges[t]);if(e.length){var n="#sel="+e.join(";");this.lastHash=n,this.options.location.setHash(n)}else this.options.location._removeHash()},readHash:function(){var e=this.splittedHash();if(e){for(var t=0;t<e.length;t++)this.deserializeSelection(e[t]);this.updateHash(),this.options.onHashRead&&this.options.onHashRead.call(this)}},splittedHash:function(){var e=this.options.location.getHash();return e?(e=e.replace(/^#/,"").replace(/;+$/,""),/^sel\=(?:\d+\:\d+(?:\:[^:;]*)?\,|%2C\d+\:\d+(?:\:[^:;]*)?;)*\d+\:\d+(?:\:[^:;]*)?\,|%2C\d+\:\d+(?:\:[^:;]*)?$/.test(e)?(e=e.substring(4,e.length)).split(";"):null):null},deserializeSelection:function(e){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges();var n=this.deserializeRange(e);n&&this.addSelection(n)},deserializeRange:function(e){var t=/^([0-9A-Za-z:]+)(?:,|%2C)([0-9A-Za-z:]+)$/.exec(e),s=t[1].split(":"),i=t[2].split(":");if(parseInt(s[0],10)<parseInt(i[0],10)||s[0]==i[0]&&parseInt(s[1],10)<=parseInt(i[1],10)){var r=this.deserializePosition(s,"start"),o=this.deserializePosition(i,"end");if(r.node&&o.node){var a=document.createRange();if(a.setStart(r.node,r.offset),a.setEnd(o.node,o.offset),a=new n.Range(a,this),!this.options.validate||this.validateRange(a,s[2],i[2]))return a}}return window.console&&"function"==typeof window.console.warn&&window.console.warn("Cannot deserialize range: "+e),null},validateRange:function(e,t,n){var s,i=!0;return t&&(s=this.getPositionChecksum(e.getWordIterator(this.regexp)),i=i&&t==s),n&&(s=this.getPositionChecksum(e.getWordIterator(this.regexp,!0)),i=i&&n==s),i},getRangeChecksum:function(e){return[this.getPositionChecksum(e.getWordIterator(this.regexp)),this.getPositionChecksum(e.getWordIterator(this.regexp,!0))]},deserializePosition:function(e,t){for(var n,s=this.blocks[parseInt(e[0],10)],i=0;s;){for(var r,o=new RegExp(this.options.regexp,"ig");null!=(r=o.exec(s.data));)if(++i==e[1])return"start"==t&&(n=r.index),"end"==t&&(n=o.lastIndex),{node:s,offset:parseInt(n,10)};(s=(s=this.nextNode(s,/.*/))?s._container:null)&&this.isFirstTextNode(s)&&(s=null)}return{node:null,offset:0}},serializeRange:function(e){var t=this.words(e.startContainer,e.startOffset,"start"),n=this.words(e.endContainer,e.endOffset,"end");if(this.options.validate){var s=this.getRangeChecksum(e);t+=":"+s[0],n+=":"+s[1]}return t+","+n},checkSelection:function(e){return this.checkPosition(e,e.startOffset,e.startContainer,"start"),this.checkPosition(e,e.endOffset,e.endContainer,"end"),this.checkBrackets(e),this.checkSentence(e),e},checkPosition:function(e,t,n,s){var i,r=this;function o(e){return null!=e.match(r.regexp)}function l(e){return null==e.match(r.regexp)}function c(e,t,n){for(;t>0&&n(e.data.charAt(t-1));)t--;return t}function d(e,t,n){for(;t<e.data.length&&n(e.data.charAt(t));)t++;return t}1==n.nodeType&&t>0&&(t<n.childNodes.length?(n=n.childNodes[t],t=0):(g=f(n)).length&&(t=(n=g[g.length-1]).data.length));if("start"==s&&(1==n.nodeType&&""!=a(h(n))&&(n=u(n),t=0),3==n.nodeType&&null!=n.data.substring(t).match(this.regexp)||(n=(i=this.nextNode(n))._container,t=i._offset),t=c(n,t=d(n,t,l),o),e.setStart(n,t)),"end"==s){var g;if(1==n.nodeType&&""!=a(h(n))&&0!=t)t=(n=(g=f(n=n.childNodes[e.endOffset-1]))[g.length-1]).data.length;3==n.nodeType&&null!=n.data.substring(0,t).match(this.regexp)||(n=(i=this.prevNode(n))._container,t=i._offset),t=d(n,t=c(n,t,l),o),e.setEnd(n,t)}},checkBrackets:function(e){this._checkBrackets(e,"(",")",/\(|\)/g,/\(x*\)/g),this._checkBrackets(e,"«","»",/\\u00ab|\\u00bb/g,/\u00abx*\u00bb/g)},_checkBrackets:function(e,t,n,s,i){var r,o=e.toString(),a=o.match(s);if(a){for(var h=(a=a.join("")).length+1;a.length<h;)h=a.length,a=a.replace(i,"x");a.charAt(a.length-1)==n&&o.charAt(o.length-1)==n&&(1==e.endOffset?(r=this.prevNode(e.endContainer),e.setEnd(r.container,r.offset)):e.setEnd(e.endContainer,e.endOffset-1)),a.charAt(0)==t&&o.charAt(0)==t&&(e.startOffset==e.startContainer.data.length?(r=this.nextNode(e.endContainer),e.setStart(r.container,r.offset)):e.setStart(e.startContainer,e.startOffset+1))}},checkSentence:function(e){var t,n;if(e.endOffset==e.endContainer.data.length){if(!(t=this.nextNode(e.endContainer,/.*/)))return null;n=t._container.data.charAt(0)}else t={_container:e.endContainer,_offset:e.endOffset},n=e.endContainer.data.charAt(e.endOffset);if(n.match(/\.|\?|\!/)){var s=e.toString();if(s.match(/(\.|\?|\!)\s+[A-Z\u0410-\u042f\u0401]/))return h();if(0==e.startOffset&&e.startContainer.previousSibling&&1==e.startContainer.previousSibling.nodeType&&p(e.startContainer.previousSibling,"masha_index"))return h();for(var i,r=e.getElementIterator();i=r();)if(1==i.nodeType&&p(i,"masha_index"))return h();if(s.charAt(0).match(/[A-Z\u0410-\u042f\u0401]/)){var o=e.startContainer.data.substring(0,e.startOffset);if(!o.match(/\S/))o=this.prevNode(e.startContainer,/\W*/)._container.data;if((o=a(o)).charAt(o.length-1).match(/(\.|\?|\!)/))return h()}return null}function h(){e.setEnd(t._container,t._offset+1)}},mergeSelections:function(e){var t=[],n=e.getElementIterator(),s=n(),i=l(s,"user_selection_true");i&&(i=/(num\d+)(?:$| )/.exec(i.className)[1],e.setStart(u(c(this.selectable,i)),0),t.push(i));for(var r=s=(n=e.getElementIterator())();s;){if(1==s.nodeType&&p(s,"user_selection_true")){var o=/(num\d+)(?:$|)/.exec(s.className)[0];-1==w(o,t)&&t.push(o)}r=s,s=n()}if(r=l(r,"user_selection_true")){r=/(num\d+)(?:$| )/.exec(r.className)[1];var a=f(function(e,t){var n=d(e,t);if(n)return n[n.length-1];return null}(this.selectable,r)),h=a[a.length-1];e.setEnd(h,h.length)}if(t.length){var g=e.startContainer,m=e.startOffset,v=e.endContainer,C=e.endOffset;this.deleteSelections(t),e.setStart(g,m),e.setEnd(v,C)}return e},addSelection:function(e){e=e||this.getFirstRange(),e=this.checkSelection(e),e=this.mergeSelections(e);var t="num"+this.counter;this.ranges[t]=this.serializeRange(e),e.wrapSelection(t+" user_selection_true"),this.addSelectionEvents(t)},addSelectionEvents:function(e){for(var t=!1,n=this,s=d(this.selectable,e),i=s.length;i--;)C(s[i],"mouseover",(function(){for(var e=s.length;e--;)m(s[e],"hover");window.clearTimeout(t)})),C(s[i],"mouseout",(function(e){for(var n=e.relatedTarget;n&&n.parentNode&&n.className!=this.className;)n=n.parentNode;n&&n.className==this.className||(t=window.setTimeout((function(){for(var e=s.length;e--;)v(s[e],"hover")}),2e3))}));var r=document.createElement("a");r.className="txtsel_close",r.href="#";var o=document.createElement("span");o.className="closewrap",o.appendChild(r),C(r,"click",(function(t){b(t),n.deleteSelections([e]),n.updateHash(),n.options.onUnmark&&n.options.onUnmark.call(n)})),s[s.length-1].appendChild(o),this.counter++,window.getSelection().removeAllRanges()},getFirstRange:function(){var e=window.getSelection(),t=e.rangeCount?e.getRangeAt(0):null;return null===t?null:this.lastRange&&t&&t.endContainer==t.startContainer&&t.endOffset==t.startOffset?this.lastRange:new n.Range(t,this)},enumerateElements:function(){var e=this.selectable;this.captureCount=this.captureCount||0;var t=this;!function e(n){for(var s=n.childNodes,i=!1,r=!1,o=0;o<s.length;++o){var a=s.item(o),h=a.nodeType;if(3!=h||a.nodeValue.match(t.regexp))if(3==h){if(!r){t.captureCount++;var l=document.createElement("span");l.className="masha_index masha_index"+t.captureCount,l.setAttribute("rel",t.captureCount),a.parentNode.insertBefore(l,a),o++,t.blocks[t.captureCount]=a,i=r=!0}}else if(1==h){if(!t.isIgnored(a))if(t.options.isBlock(a)){var c=e(a);i=i||c,r=!1}else r||(r=e(a),i=i||r)}}return i}(e)},isFirstTextNode:function(e){for(var t=[e.previousSibling,e.parentNode.previousSibling],n=t.length;n--;)if(t[n]&&1==t[n].nodeType&&"masha_index"==t[n].className)return!0;return!1},getFirstTextNode:function(e){if(!e)return null;var t=d(this.selectable,"masha_index"+e)[0];if(t)for(var n,i=s(document.body,t,void 0,!1,this.isIgnored);n=i();)if(3===n.nodeType)return n;return null},getNum:function(e){for(;e.parentNode;){for(;e.previousSibling;){for(e=e.previousSibling;1==e.nodeType&&e.childNodes.length;)e=e.lastChild;if(1==e.nodeType&&p(e,"masha_index"))return e.getAttribute("rel")}e=e.parentNode}return null},constructIgnored:function(e){if("function"==typeof e)return e;if("string"==typeof e){for(var t=[],n=[],s=[],i=e.split(","),r=0;r<i.length;r++){var o=a(i[r]);"#"==o.charAt(0)?t.push(o.substr(1)):"."==o.charAt(0)?n.push(o.substr(1)):s.push(o)}return function(e){var i;for(i=t.length;i--;)if(e.id==t[i])return!0;for(i=n.length;i--;)if(p(e,n[i]))return!0;for(i=s.length;i--;)if(e.tagName==s[i].toUpperCase())return!0;return!1}}return function(){return!1}},rangeIsSelectable:function(){var e=this.getFirstRange();if(!e)return!1;var t=e.getTextNodeIterator()();if(!t)return!1;var n=l(t,"user_selection_true"),s=e.getTextNodeIterator(!0)(),i=l(s,"user_selection_true");if(n&&i){var r=/(?:^| )(num\d+)(?:$| )/;return r.exec(n.className)[1]!==r.exec(i.className)[1]}for(var o=[t,s],a=o.length;a--;)for(var h=o[a];h!=this.selectable;)if(!(h=h.parentNode)||h instanceof HTMLDocument)return!1;return!0},initMessage:function(){this.msg="string"==typeof this.options.selectMessage?document.getElementById(this.options.selectMessage):this.options.selectMessage,this.closeButton=this.getCloseButton(),this.msgAutoclose=null,this.closeMessage=x(this.closeMessage,this),C(this.closeButton,"click",this.closeMessage)},closeMessage:function(e){b(e),this.hideMessage(),this.saveMessageClosed(),clearTimeout(this.msgAutoclose)},showMessage:function(){m(this.msg,"show")},hideMessage:function(){v(this.msg,"show")},getCloseButton:function(){return this.msg.getElementsByTagName("a")[0]},getMessageClosed:function(){return window.localStorage?!!localStorage.masha_warning:!!document.cookie.match(/(?:^|;)\s*masha-warning=/)},saveMessageClosed:function(){window.localStorage?localStorage.masha_warning="true":this.getMessageClosed()||(document.cookie+="; masha-warning=true")},_showMessage:function(){var e=this;this.getMessageClosed()||(this.showMessage(),clearTimeout(this.msgAutoclose),this.msgAutoclose=setTimeout((function(){e.hideMessage()}),1e4))}};window.Range||document.createRange().constructor;function s(e,t,n,s,i){s=!!s;var r=!(t=t||e[s?"lastChild":"firstChild"]),o=!1,a=function(e,t){if(!t)return null;for(var n=null;e&&!(e.parentNode instanceof HTMLDocument);)t(e)&&(n=e),e=e.parentNode;return n}(t,i);function h(){t.childNodes&&t.childNodes.length&&!o?t=t[s?"lastChild":"firstChild"]:t[s?"previousSibling":"nextSibling"]?(t=t[s?"previousSibling":"nextSibling"],o=!1):t.parentNode&&((t=t.parentNode)!==e&&t!==n||(r=!0),t===a&&(a=null),o=!0,h())}return function(){do{if(r)return null;var e=t,s=!!a;h(),i&&i(e)&&!s&&(a=e),e!==n||1==e.nodeType&&e.childNodes.length&&!o||(r=!0)}while((s||a)&&e!==document&&e);return e}}n.Range=function(e,t){this.range=e,this.masha=t,this.startContainer=this.range.startContainer,this.startOffset=this.range.startOffset,this.endContainer=this.range.endContainer,this.endOffset=this.range.endOffset,this.nodes=null},n.Range.prototype.setEnd=function(e,t){this.range.setEnd(e,t),this.endContainer=this.range.endContainer,this.endOffset=this.range.endOffset,this.nodes=null},n.Range.prototype.setStart=function(e,t){this.range.setStart(e,t),this.startContainer=this.range.startContainer,this.startOffset=this.range.startOffset,this.nodes=null},n.Range.prototype.toString=function(){return this.range.toString()},n.Range.prototype.fillNodes=function(){this.nodes=[];for(var e=s(document.body,this.startContainer,this.endContainer,!1,this.masha.isIgnored),t=e();t;)this.nodes.push(t),t=e()},n.Range.prototype.splitBoundaries=function(){var e=this.startContainer,t=this.startOffset,n=this.endContainer,s=this.endOffset,i=e===n;3==n.nodeType&&s<n.length&&n.splitText(s),3==e.nodeType&&t>0&&(e=e.splitText(t),i&&(s-=t,n=e),t=0),this.setStart(e,t),this.setEnd(n,s)},n.Range.prototype.getTextNodes=function(){for(var e,t=this.getElementIterator(),n=[];e=t();)3==e.nodeType&&n.push(e);return n},n.Range.prototype.getElementIterator=function(e){if(this.nodes||this.fillNodes(),e){var t=this.nodes.length;return function(){if(t>0)return t--,this.nodes[t]}.bind(this)}t=0;return function(){if(t<this.nodes.length)return t++,this.nodes[t-1]}.bind(this)},n.Range.prototype.getTextNodeIterator=function(e){var t=this.getElementIterator(e);return function(){do{var e=t();if(e&&3==e.nodeType)return e}while(e);return e}},n.Range.prototype.getWordIterator=function(e,t){var n,s,i=this.getElementIterator(t),r=0,o=0,a=!1,h=this;return function(){if(r!=o||a)t?o--:o++;else{do{do{n=i()}while(n&&3!=n.nodeType);if(!(a=!n)){var l=n.nodeValue;n==h.endContainer&&(l=l.substr(0,h.endOffset)),n==h.startContainer&&(l=l.substr(h.startOffset)),s=l.match(e)}}while(n&&!s);s&&(r=t?0:s.length-1,o=t?s.length-1:0)}return a?null:s[o]}},n.Range.prototype.wrapSelection=function(e){this.splitBoundaries();for(var t=this.getTextNodes(),n=t.length;n--;){var s=document.createElement("span");s.className=e,t[n].parentNode.insertBefore(s,t[n]),s.appendChild(t[n])}};var i=function(e){this.prefix=e};i.prototype={setHash:function(e){(e=e.replace("sel",this.prefix).replace(/^#/,"")).length==this.prefix.length+1&&(e="");var t,n=this.getHashPart();t="#"+(t=n?window.location.hash.replace(n,e):window.location.hash+"|"+e).replace("||","").replace(/^#?\|?|\|$/g,""),window.location.hash=t},addHashchange:n.LocationHandler.prototype.addHashchange,getHashPart:function(){for(var e=window.location.hash.replace(/^#\|?/,"").split(/\||%7C/),t=0;t<e.length;t++)if(e[t].substr(0,this.prefix.length+1)==this.prefix+"=")return e[t];return""},getHash:function(){return this.getHashPart().replace(this.prefix,"sel")}};e.MaSha=n,window.jQuery&&(window.jQuery.fn.masha=function(e){return e=e||{},e=o({selectable:this[0]},e),new n(e)}),e.MultiMaSha=function(e,t,s){t=t||function(e){return e.id};for(var r=0;r<e.length;r++){var a=e[r],h=t(a);if(h){var l=o({},s||{},{selectable:a,location:new i(h)});new n(l)}}};var r=n.$M={};function o(e){for(var t=1;t<arguments.length;t++)for(var n in arguments[t])e[n]=arguments[t][n];return e}function a(e){return(e||"").replace(/^\s+|\s+$/g,"")}function h(e){return e.textContent||e.innerText}function l(e,t){for(;e&&!p(e,t);)e=e.parentNode;return e||null}function c(e,t){for(var n=s(e),i=null;i=n();)if(1===i.nodeType&&p(i,t))return i;return null}function u(e,t){for(var n=s(e,void 0,void 0,void 0,t),i=null;i=n();)if(3===i.nodeType)return i;return i}function d(e,t){if(e.getElementsByClassName)return e.getElementsByClassName(t);for(var n,i=[],r=s(e);n=r();)1==n.nodeType&&p(n,t)&&i.push(n);return i}function f(e){for(var t,n=[],i=s(e);t=i();)3===t.nodeType&&n.push(t);return n}function g(e){return new RegExp("(^|\\s+)"+e+"(?:$|\\s+)","g")}function p(e,t){return g(t).test(e.className)}function m(e,t){g(t).test(e.className)||(e.className=e.className+" "+t)}function v(e,t){var n=g(t);n.test(e.className)&&(e.className=a(e.className.replace(n,"$1")))}function w(e,t){for(var n=0,s=t.length;n<s;n++)if(t[n]===e)return n;return-1}function C(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}function k(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}function b(e){e.preventDefault?e.preventDefault():e.returnValue=!1}r.extend=o,r.byClassName=d,r.addClass=m,r.removeClass=v,r.addEvent=C,r.removeEvent=k;var y=Function.prototype.bind,N=Array.prototype.slice,x=function(e,t){if(e.bind===y&&y)return y.apply(e,N.call(arguments,1));var n=N.call(arguments,2);return function(){return e.apply(t,n.concat(N.call(arguments)))}};return r.bind=x,e}));